<% get_time_spent_on_review_for_certain_team_for_each_round(map_id) %>
<% def get_link_round_review_time(map_id, round, link) %>
    <% sum_time = 0 %>
    <% links = SubmissionViewingEvent.where(map_id: map_id, round: round, link: link) %>
    <% links.each do |link_time| %>
        <% if link_time.end_at.nil? || link_time.start_at.nil? %>
            <% individual_time = 0 %>
        <% else %>
            <% individual_time = (link_time.end_at.to_i - link_time.start_at.to_i) / 60.0 %>
        <% end %>
        <% individual_time = individual_time<0? 0: individual_time %>
        <% sum_time = individual_time + sum_time %>
    <% end %>
    <% sum_time %>
<% end %>

<div id="submissionviewingevent">
  <% reviewee_list = Array.new %>
  <% total_time_list = Array.new %>
  <% timeHash = Hash.new %>
  <div class="modal fade" id="chartModal" role="dialog">
    <div class="modal-dialog">   
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title" align="center">Time Distribution</h4>
        </div>
        <div class="modal-body">
           <div id="chartContainer" style="height: 360px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>
      <% @response_maps = ResponseMap.where(reviewer_id: id, reviewed_object_id: @id, reviewee_id: reviewee_id)  %>
      <% @number_of_rounds = Assignment.find(@id).rounds_of_reviews %>
      <% reviewee_count = 0 %>
      <% @response_maps.each do |map| %>  <!-- for reviewee-->
        <% map_total_time = 0 %>
        <% (1..@number_of_rounds).each do |each_round| %>  <!-- for rounds-->
          <% @per_round_time = Array.new %>
          <% @submissionviewingevent_match = SubmissionViewingEvent.where(map_id: map.id, round:each_round)%>
          <% @reviewed_object_id = map.reviewed_object_id %>
          <% @reviewee_id = map.reviewee_id %>
          <% link_list = Array.new %>
          <% @count = 0 %>   <!--- To print revieweeId only once-->
          <% @submissionviewingevent_match.each do |submissionviewingevent_entry| %>
            <% if link_list.include?(submissionviewingevent_entry.link) %><!-- only unique links per round-->
            <% else %>
              <% link_list.push(submissionviewingevent_entry.link) %>
              <% individual_link_time = get_link_round_review_time(submissionviewingevent_entry.map_id,submissionviewingevent_entry.round,submissionviewingevent_entry.link) %>
              <% map_total_time = map_total_time + individual_link_time %>
              <% each_link_detail = Array.new %>
              <% each_link_detail << submissionviewingevent_entry.link %>
              <% each_link_detail << individual_link_time %>
              <% @per_round_time << each_link_detail %>  
              <% @count=@count+1 %>
            <% end %>   <!-- end for link-->
        <% end %>  
        <% timeHash[(@reviewee_id.to_s).concat(each_round.to_s)] = @per_round_time %>  
        <%time = instance_variable_get("@time_spent_round_" + each_round.to_s).to_f * 60 %> 
        <% if time > 0 %>
          <%seconds = time % 60%>
          <%minutes = (time / 60) % 60%>
          <%hours = time / (60 * 60)%>
          <span title="Review <%=each_round%>">
            <a onclick="drawChart(<%= @reviewee_id.to_s %>,<%= each_round.to_s %>)" data-toggle="modal" data-target="#chartModal"%>
              <% if hours.to_i>0 %>
                <%=format("%02d h %02d m %02d s", hours, minutes, seconds)%>
              <% elsif minutes.to_i>0 %>
                <%=format("%02d m %02d s", minutes, seconds)%>
              <% else %>
                <%=format("%02d s", seconds)%>
              <% end %>
            </a>
          </span> 
        <% else %>
          <span title="No review available for this round">
            ---
          </span>
        <% end %>
        <%= ', ' unless each_round == @number_of_rounds %>  
        <% end %>    <!-- end for round-->
        <% reviewee_list << @reviewee_id %>
        <% total_time_list << map_total_time.round(2) %>
        <% reviewee_count = reviewee_count+1%>
      <% end %>  <!-- end for reviewee-->
</div>
<!--- Script to update the total time column after the page load-->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.js"> </script>     <!-- Canvas JS CDN -->
<script type="text/javascript">
  var timeReportHash;
  $(document).ready(function () { 
    timeReportHash = <%= timeHash.to_json.to_s.html_safe %>;
    totalTimeList = <%= total_time_list%>
    for(each=0;each<totalTimeList.length;each++){
      // var eachId = each.toString();  
      // document.getElementById(eachId).innerHTML = totalTimeList[each];  
      $("#submissionviewingevent table #"+each).html(totalTimeList[each]);
    }       
  }); 
  function drawChart(reviewee_id,round){
      var allLinks = timeReportHash[(reviewee_id.toString()).concat(round.toString())];
      var dataArray=[];  // Data to be passed to chart
      var sum_time = 0.0;
      for(i=0;i<allLinks.length;i++){
        var dataPoint={}
        dataPoint["y"] = allLinks[i][1];
        var link_name = allLinks[i][0];
        dataPoint["label"] = link_name.slice(0,50)+(link_name.length>30? "...":"");
        dataArray.push(dataPoint);
      }
    
    var chart = new CanvasJS.Chart("chartContainer",
    { 
      theme: "dark2", // "light1", "light2", "dark1", "dark2"
	    exportEnabled: true,
	    animationEnabled: true,
      data: [
      {
        type: "pie",
        startAngle: 90,
        //showInLegend: false,
        innerRadius: 60,
        legendText: "{label}",
        yValueFormatString: "##.##",
        toolTipContent: "<b>{label}:</b>  {y}min (#percent%)",
        indexLabelFontSize: 17,
        indexLabel: "{label} - #percent%",
        dataPoints : dataArray
      }
      ]
    });
    $('#chartModal').on('shown.bs.modal',function(){
    chart.render();
    $(".canvasjs-chart-credit").css("display","none");//To remove the water mark from the chart
    });
  }
</script>